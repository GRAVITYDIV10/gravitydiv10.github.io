<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2024-02-08 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>&lrm;</title>
<meta name="generator" content="Org Mode" />
</head>
<body>
<div id="content" class="content">
<div id="outline-container-org4ea7d74" class="outline-2">
<h2 id="org4ea7d74">使用GNU EMACS开发Linux用户空间C程序</h2>
<div class="outline-text-2" id="text-org4ea7d74">
</div>
<div id="outline-container-orgb7f06ea" class="outline-3">
<h3 id="orgb7f06ea">配置GNU EMACS</h3>
<div class="outline-text-3" id="text-orgb7f06ea">
<pre class="example">
<code>package-install RET eglot RET</code>
<code>package-isntall RET company RET</code>
</pre>

<p>
在GNU EMACS初始化脚本中加入
</p>

<div class="org-src-container">
<pre class="src src-elisp"><code>(add-hook 'c-mode-hook 'eglot-ensure) ;; 在C模式自动开启eglot</code>
<code>(add-hook 'c-mode-hook 'company-mode) ;; 在C模式自动开启company</code>
</pre>
</div>
</div>
</div>

<div id="outline-container-org1fbfbac" class="outline-3">
<h3 id="org1fbfbac">编写Makefile</h3>
<div class="outline-text-3" id="text-org1fbfbac">
<div class="org-src-container">
<pre class="src src-makefile"><code>CROSS_COMPILE ?= arch-vendor-</code>
<code>CC = $(CROSS_COMPILE)gcc</code>
<code>CFLAGS += -Wall -Wextra -O3 -g3</code>
<code>CFLAGS += -march=xxx -mabi=xxx</code>
<code></code>
<code>all:</code>
<code>      $(CC) $(CFLAGS) hello.c -o hello</code>
<code></code>
<code>clean:</code>
<code>      rm -fv *.out hello</code>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgeee0729" class="outline-3">
<h3 id="orgeee0729">编写.clangd</h3>
<div class="outline-text-3" id="text-orgeee0729">
<p>
由于clangd使用主机的c编译器来处理传入的C源码文件，所以需要clangd忽略机器相关的编译器参数:
</p>

<pre class="example">
<code>CompileFlags:</code>
<code>  Add: -Wno-unknown-warning-option</code>
<code>  Remove: [-m*, -f*]</code>
</pre>
</div>
</div>

<div id="outline-container-org1d52c11" class="outline-3">
<h3 id="org1d52c11">生成 compile_commands.json</h3>
<div class="outline-text-3" id="text-org1d52c11">
<pre class="example">
<code>make clean</code>
<code>bear -- make all</code>
</pre>
</div>
</div>

<div id="outline-container-orgfdaf2ae" class="outline-3">
<h3 id="orgfdaf2ae">编写程序</h3>
<div class="outline-text-3" id="text-orgfdaf2ae">
<pre class="example">
<code>emacs hello.c</code>
</pre>

<p>
输入代码前面的字符就可以看到补全
</p>


<div id="orgc261206" class="figure">
<p><img src="emacs-and-linux-c-program.png" alt="emacs-and-linux-c-program.png" />
</p>
</div>
</div>
</div>

<div id="outline-container-org79dfe66" class="outline-3">
<h3 id="org79dfe66">上传到板子</h3>
<div class="outline-text-3" id="text-org79dfe66">
<div class="org-src-container">
<pre class="src src-shell"><code>scp hello xxx@board:/tmp/hello</code>
</pre>
</div>
</div>
</div>

<div id="outline-container-org63c5790" class="outline-3">
<h3 id="org63c5790">调试</h3>
<div class="outline-text-3" id="text-org63c5790">
</div>
<div id="outline-container-orgb008344" class="outline-4">
<h4 id="orgb008344">使用printf调试</h4>
<div class="outline-text-4" id="text-orgb008344">
<p>
在程序里面打日志作为调试手段
</p>
</div>
</div>

<div id="outline-container-orgf19ab4a" class="outline-4">
<h4 id="orgf19ab4a">远程调试</h4>
<div class="outline-text-4" id="text-orgf19ab4a">
<p>
远程板子因为资源限制通常不会提供完整的gdb用来调试，通常会安装一个gdbserver充当agent，供别的机器远程上去调试。
</p>

<p>
因为嵌入式开发的目标板子和运行GNU EMACS的PC机架构不一样，所以在运行GNU EMACS的机器上需要安装一个支持多个架构的gdb-multiarch:
</p>

<p>
<a href="https://aur.archlinux.org/packages/gdb-multiarch">https://aur.archlinux.org/packages/gdb-multiarch</a>
</p>

<p>
在板子上运行:
</p>

<div class="org-src-container">
<pre class="src src-shell"><code>gdbserver 0.0.0.0:1234 /tmp/hello  </code>
</pre>
</div>

<p>
注意:不同发行版的gdb-multiarch命名可能会不一样:
</p>

<p>
ArchLinux:
</p>

<p>
<a href="https://aur.archlinux.org/cgit/aur.git/tree/PKGBUILD?h=gdb-multiarch#n50">https://aur.archlinux.org/cgit/aur.git/tree/PKGBUILD?h=gdb-multiarch#n50</a>
</p>

<p>
Fedora:
</p>

<p>
dnf install gdb安装的gdb默认开启了multiarch
</p>

<p>
在GNU EMACS中运行:
</p>

<pre class="example">
<code>gud-gdb RET 删除原有gdb命令，然后输入gdb-multiarch，回车</code>
<code>set architecture arch</code>
<code>target remote ip:1234</code>
</pre>

<p>
之后就可以使用gdb进行调试了
</p>
</div>
</div>
</div>

<div id="outline-container-orgc6d0494" class="outline-3">
<h3 id="orgc6d0494">参考</h3>
<div class="outline-text-3" id="text-orgc6d0494">
<p>
REDHAT的远程调试指南
</p>

<p>
<a href="https://developers.redhat.com/blog/2015/04/28/remote-debugging-with-gdb">https://developers.redhat.com/blog/2015/04/28/remote-debugging-with-gdb</a>
</p>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p>Last updated: 2024-02-08</p>
</div>
</body>
</html>